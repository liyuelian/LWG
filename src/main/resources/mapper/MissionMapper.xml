<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.li.lwg.mapper.MissionMapper">

    <resultMap id="BaseResultMap" type="com.li.lwg.entity.Mission">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="mission_type" property="missionType" jdbcType="TINYINT"/>
        <result column="difficulty" property="difficulty" jdbcType="TINYINT"/>
        <result column="min_realm" property="minRealm" jdbcType="TINYINT"/>
        <result column="reward" property="reward" jdbcType="BIGINT"/>
        <result column="publisher_id" property="publisherId" jdbcType="BIGINT"/>
        <result column="acceptor_id" property="acceptorId" jdbcType="BIGINT"/>
        <result column="status" property="status" jdbcType="TINYINT"/>
        <result column="cancel_reason" property="cancelReason" jdbcType="VARCHAR"/>
        <result column="proof_data" property="proofData" jdbcType="VARCHAR"/>
        <result column="deadline" property="deadline" jdbcType="TIMESTAMP"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="accept_time" property="acceptTime" jdbcType="TIMESTAMP"/>
        <result column="submit_time" property="submitTime" jdbcType="TIMESTAMP"/>
        <result column="finish_time" property="finishTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, title, description, mission_type, difficulty, min_realm,
        reward, publisher_id, acceptor_id, status, cancel_reason,
        proof_data, deadline, version, create_time, accept_time,
        submit_time, finish_time, update_time
    </sql>

    <insert id="insert" parameterType="com.li.lwg.entity.Mission" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_mission
        (title, description, mission_type, difficulty, min_realm,
         reward, publisher_id, status, version, create_time, update_time)
        VALUES (#{title}, #{description}, #{missionType}, #{difficulty}, #{minRealm},
                #{reward}, #{publisherId}, 0, 0,
                NOW(), NOW())
    </insert>

    <select id="selectList" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM t_mission
        <where>
            <if test="status != null">
                AND status = #{status}
            </if>

            <if test="missionType != null">
                AND mission_type = #{missionType}
            </if>
            <if test="difficulty != null">
                AND difficulty = #{difficulty}
            </if>
            <if test="minRealm != null">
                AND min_realm &lt;= #{minRealm}
            </if>
            <if test="keyword != null and keyword != ''">
                <bind name="pattern" value="'%' + keyword + '%'"/>
                AND (title LIKE #{pattern} OR description LIKE #{pattern})
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_mission
        WHERE id = #{id}
    </select>

    <update id="acceptMission">
        UPDATE t_mission
        SET status      = 1,
            acceptor_id = #{acceptorId},
            accept_time = NOW(),
            version     = version + 1,
            update_time = NOW()
        WHERE id = #{id}
          AND status = 0
          AND version = #{version}   </update>


</mapper>